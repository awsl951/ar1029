<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>签到墙new</title>
    <style>
        #container {
            width: 100%;
            height: 100vh;
            overflow: scroll;
            position: relative;
        }
        #vector-image {
            width: 100%;
            cursor: grab;
            touch-action: pan-y;
        }
        .dragging {
            background-color: #cceeff; /* 蓝色背景 */
        }
        .dragging p {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
        }
        .bgM{
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;left: 0;right: 0;bottom: 0;
            z-index: 1000;
            background-color: rgba(0,0,0,0.85);
            overflow: hidden;
        }
        .bgM img{
            width: 100%;
            max-height:100%;
            position: absolute;
            top: 0;left: 0;right: 0;bottom: 0;
            z-index: 1001;
            margin: auto;
        }
    </style>
</head>
<body>
    <div id="container">
        <img id="vector-image" src="https://awsl951.oss-cn-hangzhou.aliyuncs.com/imag1/animal-2069713.svg" alt="Vector Image">
        <p id="dragging-text"></p>
    </div>

    <script>
        var isTouch = false;
        var isDoubleTouch = false; //是否为多触点   
        var start = []; //存放触点坐标
        var now, delta; //当前时间，两次触发事件时间差
        var timer = null; //计时器，触发单击事件
        var startPosition, movePosition, endPosition; //滑动起点，移动，结束点坐标
        //事件声明
        var gesturestart = new CustomEvent('gesturestart');
        var gesturechange = new CustomEvent('gesturechange');
        var gestureend = new CustomEvent('gestureend');
        var swipeMove = new CustomEvent('swipeMove');
        var doubleTouch = new CustomEvent("doubleTouch");
        var oneTouch = new CustomEvent("oneTouch");

        let image = document.getElementById("vector-image");
        let container = document.getElementById("container");
        let draggingText = document.getElementById("dragging-text");
        let isDragging = false;
        let startX, startY, startScrollX, startScrollY;

        image.addEventListener("touchstart", startDrag);
        image.addEventListener("touchmove", drag);
        image.addEventListener("touchend", endDrag);

        function startDrag(event) {
            event.preventDefault();
            if (event.touches.length < 2) {
                isDragging = true;
                startX = event.touches[0].clientX;
                startY = event.touches[0].clientY;
                startScrollX = container.scrollLeft;
                startScrollY = container.scrollTop;

                // 添加正在拖动的样式，并显示提示文字
                container.classList.add("dragging");
                draggingText.textContent = "正在拖动...";
            } else {
                isDoubleTouch = true;
                start = event.touches; //获得第一组两个点
                var screenMinPoint = getMidpoint(start[0], start[1]); //获取两个触点中心坐标
                gesturestart.midPoint = [screenMinPoint[0] - event.target.offsetLeft, screenMinPoint[1] - event.target.offsetTop]; //获取中心点坐标相对目标元素坐标
                event.target.dispatchEvent(gesturestart);
            }
        }

        function drag(event) {
            event.preventDefault();
            if (!isDragging && !isDoubleTouch) return;

            if (event.touches.length < 2 && isDragging) {
                let currentX = event.touches[0].clientX;
                let currentY = event.touches[0].clientY;
                let deltaX = currentX - startX;
                let deltaY = currentY - startY;

                // 确保图像拖动时不会超出容器的边界
                let newScrollX = startScrollX - deltaX;
                let newScrollY = startScrollY - deltaY;
                container.scrollLeft = Math.max(0, Math.min(container.scrollWidth - container.clientWidth, newScrollX));
                container.scrollTop = Math.max(0, Math.min(container.scrollHeight - container.clientHeight, newScrollY));

                // 更新拖动起始点的位置
                startX = currentX;
                startY = currentY;
            } else if (event.touches.length >= 2 && isDoubleTouch) {
                var now = event.touches; //获得第二组两个点
                var scale = getDistance(now[0], now[1]) / getDistance(start[0], start[1]); //获得缩放比例
                var rotation = getAngle(now[0], now[1]) - getAngle(start[0], start[1]); //获得旋转角度差
                gesturechange.scale = scale.toFixed(2);
                gesturechange.rotation = rotation.toFixed(2);
                event.target.dispatchEvent(gesturechange);
            }
        }

        function endDrag(event) {
            event.preventDefault();
            isDragging = false;
            isDoubleTouch = false;

            // 移除正在拖动的样式，并隐藏提示文字
            container.classList.remove("dragging");
            draggingText.textContent = "";

            if (event.touches.length < 2) {
                delta = Date.now() - now; //计算两次点击时间差
                now = Date.now();
                startPosition = [event.touches[0].pageX, event.touches[0].pageY];
                if (delta > 0 && delta <= 250) { //双击事件
                     clearTimeout(timer);
                    doubleTouch.position = [event.touches[0].pageX - event.target.offsetLeft, event.touches[0].pageY - event.target.offsetTop];
                    event.target.dispatchEvent(doubleTouch);
                } else { //滑动事件
                     timer = setTimeout(function(){
                        event.target.dispatchEvent(oneTouch);//单击事件
                    },450)
                }
                isTouch = true;
            }
        }

        /*
         * 两点的距离
         */
        function getDistance(p1, p2) {
            var x = p2.pageX - p1.pageX,
                y = p2.pageY - p1.pageY;
            return Math.sqrt((x * x) + (y * y));
        };
        /*
         * 两点的夹角
         */
        function getAngle(p1, p2) {
            var x = p1.pageX - p2.pageX,
                y = p1.pageY - p2.pageY;
            return Math.atan2(y, x) * 180 / Math.PI;
        };
        /*
         * 获取中点 
         */
        function getMidpoint(p1, p2) {
            var x = (p1.pageX + p2.pageX) / 2,
                y = (p1.pageY + p2.pageY) / 2;
            return [x, y];
        }

        var tMatrix = [1, 0, 0, 1, 0, 0]; //x缩放，无，无，y缩放，x平移，y平移
        var originLast, maxSwipeLeft, maxSwipeRight, maxSwipeTop, maxSwipeBottom; //上下左右可拖动距离

        //监听gesturestart事件，设置变换中心
        document.addEventListener('gesturestart', function(event) {
            var x = event.midPoint[0];
            var y = event.midPoint[1];
            originLast = event.midPoint;
            image.style.transformOrigin = x + "px " + y + "px";
        }, false);

        //监听gesturechange事件，进行缩放变换
        document.addEventListener('gesturechange', function(event) {
            var sc = parseFloat(event.scale);
            tMatrix[0] = tMatrix[0] + sc - 1 > 0.5 && tMatrix[0] + sc - 1 < 3 ? tMatrix[0] + sc - 1 : tMatrix[0];
            tMatrix[3] = tMatrix[3] + sc - 1 > 0.5 && tMatrix[3] + sc - 1 < 3 ? tMatrix[3] + sc - 1 : tMatrix[3];
            var temp = tMatrix.join(",");
            image.style.transform = "matrix(" + temp + ")";
        }, false);

        //监听gestureend事件，获取移动边界范围
        document.addEventListener('gestureend', function(event) {
            maxMove();
        }, false);

        //监听swipeMove事件，拖动图片
        document.addEventListener('swipeMove', function(event) {
            if (!maxSwipeLeft || !maxSwipeRight || !maxSwipeTop || !maxSwipeBottom) return;
            if (event.distance[0] > 0 && maxSwipeLeft < tMatrix[4]) return;
            if (event.distance[0] < 0 && maxSwipeRight < -tMatrix[4]) return;
            if (event.distance[1] > 0 && maxSwipeTop < tMatrix[5]) return;
            if (event.distance[1] < 0 && maxSwipeBottom < -tMatrix[5]) return;

            tMatrix[4] = tMatrix[4] + parseInt(event.distance[0]);
            tMatrix[5] = tMatrix[5] + parseInt(event.distance[1]);

            var temp = tMatrix.join(",");
            image.style.transform = "matrix(" + temp + ")";
        }, false);

        //监听doubleTouch事件，实现双击点缩放
        document.addEventListener('doubleTouch', function(event) {
            originLast = event.position;
            image.style.transformOrigin = event.position[0] + "px " + event.position[1] + "px";
            tMatrix[0] = 2;
            tMatrix[3] = 2;
            var temp = tMatrix.join(",");
            image.style.transform = "matrix(" + temp + ")";
            maxMove();
        }, false);

        //最大可拖动范围的计算
        function maxMove(){
            var sca = tMatrix[0];
            maxSwipeLeft = Math.abs(sca - 1) * originLast[0];
            maxSwipeRight = Math.abs(sca - 1) * (image.clientWidth - originLast[0]);
            maxSwipeTop = Math.abs(sca - 1) * originLast[1];
            maxSwipeBottom = Math.abs(sca - 1) * (image.clientHeight - originLast[1]);
        }
    </script>
</body>
</html>
